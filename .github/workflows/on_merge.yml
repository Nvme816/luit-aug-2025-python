
name: Analyze images on merge (prod)

on:
  push:
    branches: ["main"]

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions: { contents: read }
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
      DYNAMODB_TABLE: ${{ secrets.DYNAMODB_TABLE_PROD }}
      BRANCH_NAME: ${{ github.ref_name }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Install deps
        run: python -m pip install boto3
      - name: Configure AWS credentials
        run: |
          mkdir -p ~/.aws
          printf "[default]\naws_access_key_id=%s\naws_secret_access_key=%s\nregion=%s\n" \
            "${{ secrets.AWS_ACCESS_KEY_ID }}" \
            "${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
            "${{ secrets.AWS_REGION }}" > ~/.aws/credentials
      - name: Analyze images (JPG/PNG)
        shell: bash
        run: |
          shopt -s nullglob
          for f in images/*.jpg images/*.jpeg images/*.png; do
            echo "Processing $f"
            python recognition_pipeline_project.py "$f"
          done
